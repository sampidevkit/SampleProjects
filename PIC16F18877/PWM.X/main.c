#include "mcc_generated_files/mcc.h"
#include <math.h>
#define membersof(a) ((ssize_t)(sizeof(a)/sizeof((a)[0])))

static const uint16_t duty[]={
    0, 0, 0, 839, 845, 797, 754, 774, 851, 913, 890, 790, 701, 712, 821, 929,
    930, 813, 680, 655, 768, 918, 963, 853, 683, 608, 702, 883, 982, 901, 708,
    577, 633, 827, 981, 948, 751, 568, 568, 755, 958, 986, 807, 581, 516, 673,
    911, 1008, 868, 616, 481, 590, 844, 1008, 927, 669, 469, 511, 759, 985, 976,
    736, 482, 446, 665, 936, 1008, 809, 518, 401, 567, 863, 1016, 880, 575, 380,
    474, 772, 998, 940, 648, 386, 395, 667, 951, 983, 729, 418, 335, 557, 879, 1002,
    809, 473, 301, 451, 784, 993, 880, 547, 295, 357, 674, 953, 935, 631, 318, 281,
    555, 885, 965, 717, 366, 231, 436, 791, 966, 797, 435, 210, 327, 677, 935, 860,
    517, 218, 234, 550, 872, 900, 604, 253, 166, 420, 780, 910, 686, 310, 124, 295,
    663, 886, 753, 383, 111, 183, 529, 825, 795, 460, 122, 87, 381, 727, 801, 526,
    148, 4, 217, 578, 719, 578, 218, 4, 148, 526, 801, 728, 381, 87, 122, 460, 795,
    825, 529, 183, 111, 383, 753, 886, 664, 296, 124, 310, 686, 910, 780, 421, 166,
    253, 604, 900, 872, 551, 235, 217, 517, 860, 935, 677, 327, 210, 435, 797, 966,
    791, 436, 231, 366, 717, 965, 885, 555, 281, 318, 631, 935, 953, 674, 357, 295,
    547, 880, 993, 784, 451, 301, 473, 809, 1002, 879, 557, 335, 418, 728, 983, 951,
    667, 395, 386, 648, 940, 998, 772, 474, 380, 575, 880, 1016, 863, 567, 401, 518,
    809, 1007, 936, 665, 447, 482, 736, 976, 985, 759, 511, 469, 669, 927, 1008, 844,
    590, 481, 616, 868, 1008, 911, 674, 516, 581, 807, 986, 958, 755, 568, 568, 751,
    948, 981, 827, 633, 577, 708, 901, 982, 883, 702, 608, 683, 853, 963, 918, 768,
    655, 680, 813, 930, 929, 821, 712, 701, 790, 890, 913, 851, 774, 754, 797, 845,
    839, 0, 0, 0
};

void main(void)
{
    bool code_gen=1;
    SYSTEM_Initialize();

    while(1)
    {
#if(0)
        float y0, y1, y2, y3, y4;
        float x, res1, res2, res3;

        /* y=sqrt(cos(x))*cos(100*x)+(sqrt(abs(x))-0.7)*pow((8-x*x),0.01)+1.54
           x=-2.00:0.01:2.00         */
        RLED_SetLow();

        if(code_gen)
            printf("\n\nA=[");

        for(x=-1.6f; x<1.6f; x+=0.01f)
        {
            y0=cos(x);
            y1=sqrt(y0);
            y2=cos(x*100.0f);
            res1=y1*y2;

            if(x<0.0f)
                y0=(-1.0f)*x;
            else
                y0=x;

            y1=sqrt(y0)-0.7f;
            y3=8.0f-x*x;
            y4=pow(y3, 0.01f);
            res2=y1*y4;
            res3=res1+res2+1.54f;

            // Convert to PWM duty
            res3/=2.6f;
            res3*=1024.0f;
            PWM6_LoadDutyValue((uint16_t) res3);

            if(code_gen)
                printf("%d ", (uint16_t) res3);
            //__delay_ms(10);
        }

        if(code_gen)
        {
            code_gen=0;
            printf("];\nplot(A);");
        }
#else
        uint16_t i, sz;

        RLED_SetLow();
        sz=membersof(duty);
        //printf("\n%d", sz);

        for(i=0; i<sz; i++)
        {
            PWM6_LoadDutyValue(duty[i]);
            __delay_ms(10);
        }
#endif

        RLED_SetHigh();
        __delay_ms(100);
    }
}